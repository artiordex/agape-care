/**
 * description : schema.prisma - üìå Prisma Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà
 * author : Shiwoo Min
 * date : 2025-09-24
 * 09-28 : DDLÍ≥º ÏùºÏπòÌïòÎèÑÎ°ù Î™®Îì† ÌÖåÏù¥Î∏î Ï∂îÍ∞Ä Î∞è ÏàòÏ†ï
 * Î™ÖÎ†πÏñ¥ : pnpm prisma generate
 */

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * USERS
 * ÏÇ¨Ïö©Ïûê Í∏∞Î≥∏ Ï†ïÎ≥¥
 */
model User {
  id           BigInt    @id @default(autoincrement())
  email        String?   @unique @db.Citext
  name         String?
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz
  roleFlags    Int       @default(0) @map("role_flags")
  preferences  Json      @default("{}") @db.JsonB
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  authProviders        AuthProvider[]
  createdPrograms      Program[]            @relation("ProgramCreator")
  roomReservations     RoomReservation[]
  programParticipants  ProgramParticipant[]
  deviceRentals        DeviceRental[]
  aiInteractions       AiInteraction[]
  userActivities       UserActivity[]
  reviews              Review[]
  notifications        Notification[]

  @@map("users")
}

/**
 * AUTH_PROVIDERS
 * Î™®Îì† Ïù∏Ï¶ù ÏàòÎã®(local, google, kakao, github Îì±)ÏùÑ ÌÜµÌï© Í¥ÄÎ¶¨
 */
model AuthProvider {
  id           BigInt   @id @default(autoincrement())
  userId       BigInt   @map("user_id")
  provider     String
  providerSub  String?  @map("provider_sub")
  passwordHash String?  @map("password_hash")
  meta         Json     @default("{}") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerSub], map: "uq_provider_sub")
  /// NOTE: uq_user_local (user_id unique where provider=local) ‚Üí ÏàòÎèô validation ÌïÑÏöî
  @@map("auth_providers")
}

/**
 * PROGRAMS
 */
model Program {
  id               BigInt   @id @default(autoincrement())
  title            String
  description      String?
  createdByUserId  BigInt?  @map("created_by_user_id")
  category         String?
  meta             Json     @default("{}") @db.JsonB
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  createdBy      User?             @relation("ProgramCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  sessions       Session[]
  aiInteractions AiInteraction[]

  @@map("programs")
}

/**
 * SESSIONS
 */
model Session {
  id                BigInt    @id @default(autoincrement())
  programId         BigInt    @map("program_id")
  startsAt          DateTime  @map("starts_at") @db.Timestamptz
  endsAt            DateTime  @map("ends_at") @db.Timestamptz
  capacity          Int?
  participantFee    Int?      @map("participant_fee")
  status            String    @default("SCHEDULED")
  roomReservationId BigInt?   @unique @map("room_reservation_id")
  locationText      String?   @map("location_text")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  program         Program              @relation(fields: [programId], references: [id], onDelete: Cascade)
  roomReservation RoomReservation?     @relation(fields: [roomReservationId], references: [id], onDelete: SetNull)
  participants    ProgramParticipant[]
  aiInteractions  AiInteraction[]

  @@map("sessions")
}

/**
 * VENUES
 */
model Venue {
  id            BigInt   @id @default(autoincrement())
  name          String
  address       String?
  openingHours  Json?    @map("opening_hours") @db.JsonB
  blackoutRules Json?    @map("blackout_rules") @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  rooms Room[]

  @@map("venues")
}

/**
 * ROOMS
 */
model Room {
  id        BigInt   @id @default(autoincrement())
  venueId   BigInt   @map("venue_id")
  name      String
  capacity  Int?
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  venue        Venue             @relation(fields: [venueId], references: [id], onDelete: Cascade)
  reservations RoomReservation[]

  @@unique([venueId, name], map: "rooms_uniq_per_venue")
  @@map("rooms")
}

/**
 * ROOM_RESERVATIONS
 */
model RoomReservation {
  id        BigInt    @id @default(autoincrement())
  roomId    BigInt    @map("room_id")
  userId    BigInt?   @map("user_id")
  startsAt  DateTime  @map("starts_at") @db.Timestamptz
  endsAt    DateTime  @map("ends_at") @db.Timestamptz
  /// periodÏùÄ generated columnÏù¥ÎØÄÎ°ú PrismaÏóêÏÑú Ï†úÏô∏
  purpose   String?
  status    String    @default("PENDING")
  meta      Json      @default("{}") @db.JsonB
  sessionId BigInt?   @unique @map("session_id")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  room    Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  session Session?

  @@map("room_reservations")
}

/**
 * PROGRAM_PARTICIPANTS
 */
model ProgramParticipant {
  id        BigInt    @id @default(autoincrement())
  sessionId BigInt    @map("session_id")
  userId    BigInt    @map("user_id")
  role      String    @default("ATTENDEE")
  status    String    @default("APPLIED")
  joinedAt  DateTime? @default(now()) @map("joined_at") @db.Timestamptz

  /// Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId], map: "program_participants_uniq")
  @@map("program_participants")
}

/**
 * DEVICES
 * ÎåÄÏó¨ Í∞ÄÎä•Ìïú Ïû•ÎπÑ
 */
model Device {
  id        BigInt   @id @default(autoincrement())
  name      String
  type      String?
  specs     Json     @default("{}") @db.JsonB
  status    String   @default("AVAILABLE")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  rentals DeviceRental[]

  @@map("devices")
}

/**
 * DEVICE_RENTALS
 * Ïû•ÎπÑ ÎåÄÏó¨ ÎÇ¥Ïó≠
 */
model DeviceRental {
  id        BigInt   @id @default(autoincrement())
  deviceId  BigInt   @map("device_id")
  userId    BigInt   @map("user_id")
  startsAt  DateTime @map("starts_at") @db.Timestamptz
  endsAt    DateTime @map("ends_at") @db.Timestamptz
  status    String   @default("PENDING")
  meta      Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("device_rentals")
}

/**
 * AI_INTERACTIONS
 * AI ÏÇ¨Ïö© Î°úÍ∑∏ Î∞è ÎπÑÏö© Ï∂îÏ†Å
 */
model AiInteraction {
  id               BigInt    @id @default(autoincrement())
  userId           BigInt?   @map("user_id")
  programId        BigInt?   @map("program_id")
  sessionId        BigInt?   @map("session_id")
  provider         String
  model            String
  kind             String
  promptTokens     Int       @default(0) @map("prompt_tokens")
  completionTokens Int       @default(0) @map("completion_tokens")
  cost             Decimal   @default(0) @db.Decimal(12, 6)
  status           String    @default("OK")
  traceId          String?   @map("trace_id")
  meta             Json      @default("{}") @db.JsonB
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz

  /// Relations
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  program Program? @relation(fields: [programId], references: [id], onDelete: SetNull)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@map("ai_interactions")
}

/**
 * USER_ACTIVITIES
 * ÏÇ¨Ïö©Ïûê ÌôúÎèô Î°úÍ∑∏ (AI Ï∂îÏ≤úÏö©)
 */
model UserActivity {
  id         BigInt   @id @default(autoincrement())
  userId     BigInt?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   BigInt?  @map("entity_id")
  meta       Json     @default("{}") @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  /// Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("user_activities")
}

/**
 * REVIEWS
 * Î¶¨Î∑∞ ÏãúÏä§ÌÖú
 */
model Review {
  id         BigInt   @id @default(autoincrement())
  userId     BigInt   @map("user_id")
  targetType String   @map("target_type")
  targetId   BigInt   @map("target_id")
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  /// Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId], map: "reviews_unique_per_target")
  @@map("reviews")
}

/**
 * NOTIFICATIONS
 * ÏïåÎ¶º ÏãúÏä§ÌÖú
 */
model Notification {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @map("user_id")
  type      String
  title     String
  message   String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  /// Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
