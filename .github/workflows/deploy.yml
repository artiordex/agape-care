# Description : deploy.yml - ğŸ“Œ Agape-Care ë³€ê²½ëœ ì•± Docker ë¹Œë“œ & í‘¸ì‹œ
# Author : Shiwoo Min
# Date : 2026-01-22
# - Agape-Care monorepo êµ¬ì¡° ëŒ€ì‘
# - ë³€ê²½ëœ ì•±ë§Œ ë©€í‹°ì•„í‚¤(amd64/arm64) ë¹Œë“œ
# - GHCR ê¸°ë°˜ ì´ë¯¸ì§€ í‘¸ì‹œ
# - fail-fast ë¹„í™œì„±í™”ë¡œ ì„œë¹„ìŠ¤ ë‹¨ìœ„ ë…ë¦½ ë°°í¬

name: Deploy

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NS: artiordex/agape-care

permissions:
  contents: read
  packages: write

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        service: [api, admin, web, worker]

    steps:
      # Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # ë³€ê²½ ê°ì§€ (ì„œë¹„ìŠ¤ë³„)
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/**'
              - 'infra/docker/Dockerfile.api'
            admin:
              - 'apps/admin/**'
              - 'packages/**'
              - 'infra/docker/Dockerfile.admin'
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'infra/docker/Dockerfile.web'
            worker:
              - 'apps/worker/**'
              - 'packages/**'
              - 'infra/docker/Dockerfile.worker'

      # ë¹Œë“œ ì—¬ë¶€ íŒë‹¨
      - name: Check build gate
        id: gate
        shell: bash
        run: |
          if [ "${{ steps.changes.outputs[matrix.service] }}" != "true" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      # QEMU (ë©€í‹°ì•„í‚¤)
      - name: Setup QEMU
        if: steps.gate.outputs.skip != 'true'
        uses: docker/setup-qemu-action@v3

      # Buildx
      - name: Setup Docker Buildx
        if: steps.gate.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3

      # GHCR ë¡œê·¸ì¸
      - name: Login to GHCR
        if: steps.gate.outputs.skip != 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Docker ë©”íƒ€ë°ì´í„°
      - name: Extract Docker metadata
        if: steps.gate.outputs.skip != 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NS }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # Build & Push
      - name: Build & Push Docker image
        if: steps.gate.outputs.skip != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

          # ì„œë¹„ìŠ¤ ë‹¨ìœ„ ìºì‹œ ë¶„ë¦¬
          cache-from: type=gha,scope=agape-${{ matrix.service }}
          cache-to: type=gha,scope=agape-${{ matrix.service }},mode=max

          # ë©€í‹° ì•„í‚¤í…ì²˜
          platforms: linux/amd64,linux/arm64

          # ë³´ì•ˆ ë©”íƒ€ ë¹„í™œì„±í™” (ì†ë„/ë‹¨ìˆœí™”)
          provenance: false
          sbom: false
