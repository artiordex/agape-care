# Description : Dockerfile.admin - ğŸ“Œ Agape Care Admin (Next.js Standalone)
# Author : Shiwoo Min
# Date : 2026-01-25

# Build Stage (Next.js + pnpm)
FROM node:20-alpine AS build
WORKDIR /app

RUN npm install -g pnpm

# ë£¨íŠ¸ ë©”íƒ€íŒŒì¼ ë³µì‚¬
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

# workspace ë³µì‚¬
COPY apps ./apps
COPY packages ./packages

# admin ì „ìš© workspace ì˜ì¡´ì„± ì„¤ì¹˜
RUN pnpm install --filter admin... --frozen-lockfile

# Next.js Admin ì•±ì„ standaloneìœ¼ë¡œ ë¹Œë“œ
RUN pnpm --filter @agape-care/admin build

# Runtime Stage (Next.js Standalone)
FROM node:20-alpine AS runner
WORKDIR /app

# Next.js standalone ì„œë²„ íŒŒì¼ë“¤
COPY --from=build /app/apps/admin/.next/standalone ./
COPY --from=build /app/apps/admin/.next/static ./.next/static
COPY --from=build /app/apps/admin/public ./public

# Admin í¬íŠ¸
EXPOSE 3001

# Next.js standalone ì„œë²„ ì‹¤í–‰
CMD ["node", "server.js"]
