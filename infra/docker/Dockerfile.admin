# Description : Dockerfile.admin - ğŸ“Œ Agape Care Admin (Next.js Standalone)
# Author : Shiwoo Min
# Date : 2026-01-25
# docker build -f infra/docker/Dockerfile.admin -t agape-care-admin . --progress=plain
# Admin (í¬íŠ¸ 3001 ë§¤í•‘)
# docker run -d -p 3001:3001 --name agape-admin agape-care-admin

# Build Stage
FROM node:22-alpine AS build
WORKDIR /app

# husky ë¹„í™œì„±í™”
ENV HUSKY=0

RUN npm install -g pnpm

# Root workspace files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

# Workspace packages
COPY apps ./apps
COPY packages ./packages

# ì „ì²´ workspace ì˜ì¡´ì„± ì„¤ì¹˜ (í•„í„° ì œê±°)
RUN pnpm install --frozen-lockfile

# Build admin (Next.js standalone)
RUN pnpm nx build @agape-care/admin --skip-nx-cache

# Runtime Stage
FROM node:22-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3001
ENV HOSTNAME="0.0.0.0"

# standalone ë¹Œë“œ ê²°ê³¼ë¬¼ ì „ì²´ë¥¼ ë³µì‚¬ (monorepo êµ¬ì¡° ìœ ì§€)
COPY --from=build /app/dist/apps/admin/.next/standalone ./

# Next.js static assets
COPY --from=build /app/dist/apps/admin/.next/static ./.next/static
COPY --from=build /app/dist/apps/admin/.next/static ./apps/admin/.next/static

# public í´ë”ê°€ ë¹„ì–´ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¹ˆ í´ë” ìƒì„±
RUN mkdir -p ./apps/admin/public

EXPOSE 3001

# monorepo êµ¬ì¡°ì— ë§ê²Œ ì‹¤í–‰
CMD ["node", "apps/admin/server.js"]
