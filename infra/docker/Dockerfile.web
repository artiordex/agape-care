# Description : Dockerfile.web - ğŸ“Œ Agape Care Web (Next.js)
# Author : Shiwoo Min
# Date : 2026-01-25

# Build Stage (Next.js + pnpm)
FROM node:20-alpine AS build
WORKDIR /app

RUN npm install -g pnpm

# ë£¨íŠ¸ ë©”íƒ€íŒŒì¼ ë³µì‚¬
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

# workspace ë³µì‚¬
COPY apps ./apps
COPY packages ./packages

# web ì „ìš© workspace ì˜ì¡´ì„± ì„¤ì¹˜
RUN pnpm install --filter web... --frozen-lockfile

# Next.js standaloneìœ¼ë¡œ ë¹Œë“œ
RUN pnpm --filter @agape-care/web build

# Runtime Stage (standalone)
FROM node:20-alpine AS runner
WORKDIR /app

# Next.js standalone ì„œë²„ íŒŒì¼ë“¤
COPY --from=build /app/apps/web/.next/standalone ./
COPY --from=build /app/apps/web/.next/static ./.next/static
COPY --from=build /app/apps/web/public ./public

# Web í¬íŠ¸
EXPOSE 3000

# Next.js standalone ì„œë²„ ì‹¤í–‰
CMD ["node", "server.js"]
