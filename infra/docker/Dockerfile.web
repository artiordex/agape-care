# Description : Dockerfile.web - ğŸ“Œ Agape Care Web (Next.js)
# Author : Shiwoo Min
# Date : 2026-01-25
# docker build -f infra/docker/Dockerfile.web -t agape-care-web . --progress=plain
# docker build --no-cache -f infra/docker/Dockerfile.web -t agape-care-web .
# Web (í¬íŠ¸ 3000 ë§¤í•‘)
# docker run -d -p 3000:3000 --name agape-web agape-care-web

# Build Stage
FROM node:22-alpine AS build
WORKDIR /app

# husky ë¹„í™œì„±í™”
ENV HUSKY=0

RUN npm install -g pnpm

# Root workspace files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

COPY apps ./apps
COPY packages ./packages

# ì „ì²´ workspace ì˜ì¡´ì„± ì„¤ì¹˜ (í•„í„° ì œê±°)
RUN pnpm install --frozen-lockfile

# Build web (Next.js standalone)
RUN pnpm nx build @agape-care/web

# Runtime Stage
FROM node:22-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# standalone ë¹Œë“œ ê²°ê³¼ë¬¼ ì „ì²´ ë³µì‚¬
COPY --from=build /app/dist/apps/web/.next/standalone ./

# Next.js static assets
COPY --from=build /app/dist/apps/web/.next/static ./.next/static
COPY --from=build /app/dist/apps/web/.next/static ./apps/web/.next/static

# public í´ë”ê°€ ë¹„ì–´ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¹ˆ í´ë” ìƒì„±
RUN mkdir -p ./apps/web/public

EXPOSE 3000

CMD ["node", "apps/web/server.js"]
