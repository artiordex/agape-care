# Description : Dockerfile.api - ğŸ“Œ Agape Care API (NestJS)
# Author : Shiwoo Min
# Date : 2026-01-25

# Base: deps install (devDependencies í¬í•¨)
FROM node:20-alpine AS deps
WORKDIR /app
ENV HUSKY=0 

RUN npm install -g pnpm

# ë£¨íŠ¸ ë©”íƒ€íŒŒì¼ ë³µì‚¬
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

# workspace ë³µì‚¬
COPY apps ./apps
COPY packages ./packages

# api ì „ìš© workspace ì˜ì¡´ì„± ì„¤ì¹˜
RUN pnpm install --filter api... --frozen-lockfile

# NestJS API ì•±ì„ ë¹Œë“œ
FROM node:20-alpine AS builder
WORKDIR /app

COPY --from=deps /app ./

# API ë¹Œë“œ
RUN pnpm exec nx build @agape-care/api

# Runtime (production)
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

RUN npm install -g pnpm

# package.jsonë§Œ ë³µì‚¬í•´ì„œ prod deps ì„¤ì¹˜
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
RUN pnpm install --prod --frozen-lockfile

# ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬
COPY --from=builder /app/dist/apps/api ./dist

EXPOSE 8000

CMD ["node", "dist/main.js"]
