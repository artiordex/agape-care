# ---------------------------------------------------------
# Description : Dockerfile.api - ğŸ“Œ ConnectWon API (NestJS)
# Author      : Shiwoo Min
# Date        : 2026-01-25
#
# - pnpm ê¸°ë°˜ ëª¨ë…¸ë ˆí¬
# - Nx ê¸°ë°˜ NestJS API ë¹Œë“œ ì§€ì›
# - Build Stage: devDependencies í¬í•¨
# - Runtime Stage: production only
# ---------------------------------------------------------

# ---------------------------------------------------------
# API Build Stage (NestJS + Nx)
# ---------------------------------------------------------
FROM node:20-alpine AS build
WORKDIR /app

RUN npm install -g pnpm

# ë£¨íŠ¸ íŒŒì¼ ë³µì‚¬
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
     tsconfig.json tsconfig.base.json ./

# workspace ë³µì‚¬
COPY apps ./apps
COPY packages ./packages

# devDependencies í¬í•¨ ì„¤ì¹˜ (Nx ë¹Œë“œì— í•„ìš”)
RUN pnpm install --workspace-root --no-frozen-lockfile

# Nx API ë¹Œë“œ
RUN pnpm exec nx build @agape-care/api

# ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…ìš© - ë‚˜ì¤‘ì— ì œê±° ê°€ëŠ¥)
RUN echo "Build output:" && ls -la dist/


# ---------------------------------------------------------
# Runtime Stage (prod only)
# ---------------------------------------------------------
FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
     tsconfig.json tsconfig.base.json ./

COPY apps/api ./apps/api
COPY packages ./packages

# production install only
RUN pnpm install --filter api... --prod --no-frozen-lockfile --ignore-scripts

# Nx ë¹Œë“œ ê²°ê³¼ëŠ” dist/apps/apiì— ìƒì„±ë¨
COPY --from=build /app/dist/apps/api ./dist/apps/api

# node_modulesë„ ë³µì‚¬ (í•„ìš”í•œ ê²½ìš°)
COPY --from=build /app/node_modules ./node_modules

EXPOSE 8000
CMD ["node", "dist/apps/api/main.js"]
