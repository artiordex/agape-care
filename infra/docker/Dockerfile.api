# Description : Dockerfile.api - ğŸ“Œ Agape Care API (NestJS)
# Author : Shiwoo Min
# Date : 2026-01-25
# docker build -f infra/docker/Dockerfile.api -t agape-care-api . --progress=plain
# docker build --no-cache -f infra/docker/Dockerfile.api -t agape-care-api . --progress=plain

# Build Stage
FROM node:22-alpine AS builder
WORKDIR /app
ENV HUSKY=0

RUN npm install -g pnpm
RUN apk add --no-cache python3 make g++ pkgconfig cairo-dev pango-dev libjpeg-turbo-dev giflib-dev pixman-dev

# Root workspace files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

# Workspace packages
COPY apps ./apps
COPY packages ./packages

# Prisma schema ë³µì‚¬
COPY infra/database ./infra/database

# ì „ì²´ workspace ì˜ì¡´ì„± ì„¤ì¹˜
RUN pnpm install --frozen-lockfile

# Prisma generate
RUN pnpm db:generate || true

# API ë¹Œë“œ
RUN pnpm nx build @agape-care/api

# Prisma client ìœ„ì¹˜ í™•ì¸ (ë””ë²„ê¹…)
RUN echo "=== Prisma client location ===" && \
    find /app -name ".prisma" -type d || echo "No .prisma found"

RUN echo "=== Builder Output Contents: /app/apps/api/dist ==="
RUN ls -R /app/apps/api/dist || echo "/app/apps/api/dist not found"
RUN echo "=== Builder Output Contents: /app/dist ==="
RUN ls -R /app/dist || echo "/app/dist not found"

# Runtime Stage
FROM node:22-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV HUSKY=0

RUN apk add --no-cache cairo pango libjpeg-turbo giflib pixman

# node_modules ì „ì²´ ë³µì‚¬
COPY --from=builder /app/node_modules ./node_modules

# ë‚´ë¶€ íŒ¨í‚¤ì§€ ë³µì‚¬
COPY --from=builder /app/packages ./packages

# Prisma client ë³µì‚¬ (ì„ íƒì  - ì—†ì–´ë„ node_modulesì— í¬í•¨ë¨)
# COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder /app/apps/api/dist ./dist

RUN echo "=== Runner Dist Contents ==="
RUN ls -R ./dist

# package.json ë³µì‚¬
COPY --from=builder /app/package.json ./package.json

EXPOSE 8000

CMD ["node", "dist/main.js"]
