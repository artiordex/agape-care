# Description : Dockerfile.api - ğŸ“Œ Agape Care API (NestJS)
# Author : Shiwoo Min
# Date : 2026-01-25
# docker build -f infra/docker/Dockerfile.api -t agape-care-api . --progress=plain
# docker build --no-cache -f infra/docker/Dockerfile.api -t agape-care-api . --progress=plain
# ë„ì»¤ ì£½ê¸° ì „ì— ë“¤ì–´ê°€ê¸°: docker run -it --entrypoint sh agape-care-api:latest

# Build Stage
FROM node:22-alpine AS builder
WORKDIR /app
ENV HUSKY=0

RUN npm install -g pnpm
RUN apk add --no-cache python3 make g++ pkgconfig cairo-dev pango-dev libjpeg-turbo-dev giflib-dev pixman-dev

COPY . .

RUN pnpm install --frozen-lockfile

# Prisma Generate
ENV DATABASE_URL="postgresql://dummy:dummy@dummy:5432/dummy"
RUN pnpm --filter @agape-care/database generate

# API ë¹Œë“œ
# API ë¹Œë“œ
RUN pnpm nx build @agape-care/api --skip-nx-cache

# ê²¬ê³ í•œ ì²˜ë¦¬: srcê°€ ì¡´ì¬í•˜ë©´ í‰íƒ„í™” (Local/Docker ì°¨ì´ ëŒ€ì‘)
RUN if [ -d "/app/dist/apps/api/src" ]; then \
      echo "Flattening nested structure..."; \
      cp -r /app/dist/apps/api/src/. /app/dist/apps/api/; \
      rm -rf /app/dist/apps/api/src; \
    else \
      echo "Structure is already flat."; \
    fi

# Production Dependencies Stage
FROM node:22-alpine AS deps
WORKDIR /app

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/api/package.json ./apps/api/
COPY packages/database/package.json ./packages/database/
COPY packages/logger/package.json ./packages/logger/
COPY packages/api-contract/package.json ./packages/api-contract/

RUN pnpm --filter @agape-care/api --prod --ignore-scripts deploy /tmp/api-deploy

WORKDIR /tmp/api-deploy
RUN pnpm exec prisma generate || true

# Runtime Stage
FROM node:22-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

RUN apk add --no-cache cairo pango libjpeg-turbo giflib pixman

COPY --from=deps /tmp/api-deploy/node_modules ./node_modules
COPY --from=deps /tmp/api-deploy/package.json ./package.json

# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder /app/dist/apps/api ./dist

EXPOSE 8000

CMD ["node", "dist/main.js"]
