# Description : Dockerfile.worker - ğŸ“Œ Agape Care Worker (NestJS)
# Author : Shiwoo Min
# Date : 2026-01-27
# docker build --no-cache -f infra/docker/Dockerfile.worker -t agape-care-worker .

# Build Stage
FROM node:22-slim AS builder
WORKDIR /app

# devDependencies ì„¤ì¹˜ë˜ë„ë¡ ì§€ì •
ENV NODE_ENV=development
ENV HUSKY=0

# nest-cli PATH ë¬¸ì œ í•´ê²° (pnpm workspace í™˜ê²½ì—ì„œ í•„ìˆ˜)
ENV PATH="/app/node_modules/.bin:/app/apps/worker/node_modules/.bin:$PATH"

RUN apt-get update && apt-get install -y \
    python3 make g++ pkg-config libcairo2-dev libpango1.0-dev \
    libjpeg-dev libgif-dev libpixman-1-dev libglib2.0-dev openssl \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm

# root ì„¤ì • íŒŒì¼ë“¤
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

# workspace êµ¬ì¡°
COPY apps ./apps
COPY packages ./packages
COPY infra/database ./infra/database

# Dependencies install
RUN pnpm install --frozen-lockfile

# Prisma generate
RUN pnpm db:generate || true

# Nx build (Nest CLI PATH ì„¤ì • ë•ë¶„ì— nest build ë¬¸ì œ í•´ê²°ë¨)
RUN pnpm nx build @agape-care/worker

# Runtime Stage
FROM node:22-slim AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV HUSKY=0

RUN apt-get update && apt-get install -y \
    libcairo2 libpango-1.0-0 libjpeg62-turbo libgif7 \
    libpixman-1-0 libglib2.0-0 openssl \
    && rm -rf /var/lib/apt/lists/*

# Only runtime needs
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/packages ./packages
COPY --from=builder /app/dist/apps/worker ./dist
COPY --from=builder /app/package.json ./package.json

CMD ["node", "dist/main.js"]
