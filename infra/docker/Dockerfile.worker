# Description : Dockerfile.worker - ğŸ“Œ Agape Care Worker (NestJS)
# Author : Shiwoo Min
# Date : 2026-01-25

# Worker Build Stage
FROM node:20-slim AS deps
WORKDIR /app

RUN apt-get update && apt-get install -y \
    python3 make g++ libcairo2-dev libpango1.0-dev \
    libjpeg-dev libgif-dev libpixman-1-dev libglib2.0-dev openssl \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

COPY apps ./apps
COPY packages ./packages

# Husky ë¹„í™œì„±í™”
ENV HUSKY=0

# worker workspace ì„¤ì¹˜
RUN pnpm install --filter worker... --frozen-lockfile

# Builder
FROM node:20-slim AS builder
WORKDIR /app

COPY --from=deps /app ./

# Prisma generate (ìˆìœ¼ë©´ ì‹¤í–‰, ì—†ìœ¼ë©´ ë¬´ì‹œ)
RUN pnpm --filter @agape-care/worker exec prisma generate || true

# Worker ë¹Œë“œ
RUN pnpm exec nx build @agape-care/worker

# Runtime (Production)
FROM node:20-slim AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV HUSKY=0

# ëŸ°íƒ€ì„ì— í•„ìš”í•œ ìµœì†Œ native libs
RUN apt-get update && apt-get install -y \
    libcairo2 libpango-1.0-0 libjpeg62-turbo libgif7 \
    libpixman-1-0 libglib2.0-0 openssl \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# production deps ì„¤ì¹˜ (husky ë¬´ì‹œ)
RUN pnpm install --filter worker... --prod --frozen-lockfile

# ë¹Œë“œ ì‚°ì¶œë¬¼ë§Œ ë³µì‚¬
COPY --from=builder /app/dist/apps/worker ./dist

CMD ["node", "dist/main.js"]
