# Description : Dockerfile.worker - ğŸ“Œ Agape Care Worker (NestJS)
# Author : Shiwoo Min
# Date : 2026-01-27
# docker build --no-cache -f infra/docker/Dockerfile.worker -t agape-care-worker .

# Build Stage
FROM node:22-alpine AS builder
WORKDIR /app
ENV HUSKY=0

RUN npm install -g pnpm
RUN apk add --no-cache python3 make g++ pkgconfig cairo-dev pango-dev libjpeg-turbo-dev giflib-dev pixman-dev

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json \
    tsconfig.json tsconfig.base.json ./

COPY apps/worker ./apps/worker
COPY packages ./packages
COPY infra/database ./infra/database

RUN pnpm install --frozen-lockfile

# Prisma Generate
ENV DATABASE_URL="postgresql://dummy:dummy@dummy:5432/dummy"
RUN pnpm db:generate || true

RUN pnpm nx build @agape-care/worker

# Production Dependencies Stage (pnpm deploy ì‚¬ìš©)
FROM node:22-alpine AS deps
WORKDIR /app
ENV HUSKY=0

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/worker/package.json ./apps/worker/
COPY packages/database/package.json ./packages/database/
COPY packages/logger/package.json ./packages/logger/
COPY packages/api-contract/package.json ./packages/api-contract/

# pnpm deployë¡œ workerì— í•„ìš”í•œ ê²ƒë§Œ ì¶”ì¶œ
RUN pnpm --filter @agape-care/worker --prod --ignore-scripts deploy /tmp/worker-deploy

# Prisma Generate (deployëœ í´ë”ì—ì„œ)
WORKDIR /tmp/worker-deploy
RUN pnpm exec prisma generate || true

# Runtime Stage
FROM node:22-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

RUN apk add --no-cache cairo pango libjpeg-turbo giflib pixman

# Deployëœ node_modulesë§Œ ë³µì‚¬ (Prisma client í¬í•¨ë¨)
COPY --from=deps /tmp/worker-deploy/node_modules ./node_modules

# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder /app/dist/apps/worker/ ./dist

# package.json ë³µì‚¬
COPY --from=deps /tmp/worker-deploy/package.json ./package.json

CMD ["node", "dist/main.js"]
