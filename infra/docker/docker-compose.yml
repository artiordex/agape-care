# Description : docker-compose.yml - üìå ÎèÑÏª§ Ïª¥Ìè¨Ï¶à ÏÑ§Ï†ï ÌååÏùº
# Author : Shiwoo Min
# Date : 2025-09-24
# 09-16 - ports Ï∂îÍ∞Ä, network ÏÑ§Ï†ï Ï∂îÍ∞Ä, healthcheck ÏàòÏ†ï
# 09-17 - Grafana ÏûêÍ≤©Ï¶ùÎ™Ö/Ìè¨Ìä∏/ROOT_URL ÌïòÎìúÏΩîÎî© Ï†úÍ±∞ ‚Üí Î£®Ìä∏ .env ÏÇ¨Ïö©
# 09-24 - Ïª®ÌÖåÏù¥ÎÑàÍ∞Ñ DB/Redis Ïó∞Í≤∞ ÏàòÏ†ï, Î∂àÌïÑÏöîÌïú ÌôòÍ≤ΩÎ≥ÄÏàò Ï†ïÎ¶¨
# Ïù∏ÌîÑÎùºÎßå Ïò¨Î¶¨Í∏∞: docker compose -p connectwon --env-file .env -f infra/docker/docker-compose.yml up -d postgres redis redisinsight prometheus grafana n8n
# Î£®Ìä∏ÏóêÏÑú ÎπåÎìú: docker compose -p connectwon --env-file .env -f infra/docker/docker-compose.yml up -d

services:
  # Next.js (Ïõπ ÌîÑÎ°†Ìä∏ÏóîÎìú)
  web:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.web
    container_name: web
    env_file:
      - ../../.env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${WEB_PORT:-3000}
      - HOST=0.0.0.0
      - NX_DAEMON=false
      - NX_CLOUD=${NX_CLOUD:-false}
      - NX_CLOUD_ACCESS_TOKEN=${NX_CLOUD_ACCESS_TOKEN}
      # URL ÏÑ§Ï†ï
      - NEXT_PUBLIC_API_URL=${API_URL:-http://localhost:8000}
      - NEXT_PUBLIC_WEB_URL=${WEB_URL:-http://localhost:3000}
      # Í∏∞Îä• ÌîåÎûòÍ∑∏
      - NEXT_PUBLIC_FEATURE_AI_RECOMMENDATIONS=${FEATURE_AI_RECOMMENDATIONS:-true}
      - NEXT_PUBLIC_FEATURE_PAYMENT_GATEWAY=${FEATURE_PAYMENT_GATEWAY:-true}
    expose:
      - '3000'
    ports:
      - '0.0.0.0:${WEB_PORT:-3000}:3000'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(''http'').get(''http://localhost:3000'',r=>process.exit(r.statusCode===200?0:1)).on(''error'',()=>process.exit(1))"',
        ]
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      - connectwon-network

  # Nest.js API (Î∞±ÏóîÎìú)
  api:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.api
    container_name: api
    env_file:
      - ../../.env
    environment:
      # Í∞úÎ∞úÌôòÍ≤ΩÏóêÏÑú ÌååÏùº Î≥ÄÍ≤Ω Í∞êÏßÄ ÏÑ§Ï†ï
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${API_PORT:-8000}
      - HOST=0.0.0.0
      - NX_DAEMON=false
      - NX_CLOUD=${NX_CLOUD:-false}
      - NX_CLOUD_ACCESS_TOKEN=${NX_CLOUD_ACCESS_TOKEN}
      # Ïª®ÌÖåÏù¥ÎÑàÍ∞Ñ Ïó∞Í≤∞ÏùÑ ÏúÑÌïú Ïò§Î≤ÑÎùºÏù¥Îìú
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/${REDIS_DB}
    expose:
      - '8000'
    ports:
      - '0.0.0.0:${API_PORT:-8000}:8000'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(''http'').get(''http://localhost:8000/health'',r=>process.exit(r.statusCode===200?0:1)).on(''error'',()=>process.exit(1))"',
        ]
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      - connectwon-network

  # Next.js (Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú)
  admin:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.admin
    container_name: admin
    env_file:
      - ../../.env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${ADMIN_PORT:-3001}
      - HOST=0.0.0.0
      - NX_DAEMON=false
      - NX_CLOUD=${NX_CLOUD:-false}
      - NX_CLOUD_ACCESS_TOKEN=${NX_CLOUD_ACCESS_TOKEN}
      # URL ÏÑ§Ï†ï
      - NEXT_PUBLIC_API_URL=${API_URL:-http://localhost:8000}
      - NEXT_PUBLIC_ADMIN_URL=${ADMIN_URL:-http://localhost:3001}
      # Í∏∞Îä• ÌîåÎûòÍ∑∏
      - NEXT_PUBLIC_FEATURE_ADVANCED_ANALYTICS=${FEATURE_ADVANCED_ANALYTICS:-false}
    expose:
      - '3001'
    ports:
      - '0.0.0.0:${ADMIN_PORT:-3001}:3001'
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(''http'').get(''http://localhost:3001'',r=>process.exit(r.statusCode===200?0:1)).on(''error'',()=>process.exit(1))"',
        ]
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      - connectwon-network

  # BullMQ Worker (Î∞±Í∑∏ÎùºÏö¥Îìú ÏûëÏóÖÏûê)
  worker:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.worker
    container_name: worker
    restart: unless-stopped
    env_file:
      - ../../.env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # Ïª®ÌÖåÏù¥ÎÑàÍ∞Ñ Ïó∞Í≤∞ÏùÑ ÏúÑÌïú Redis URL Ïò§Î≤ÑÎùºÏù¥Îìú
      - QUEUE_REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/${QUEUE_REDIS_DB}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - NX_DAEMON=false
      - NX_CLOUD=${NX_CLOUD:-false}
      - NX_CLOUD_ACCESS_TOKEN=${NX_CLOUD_ACCESS_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: >
        CMD-SHELL node -e "require('redis').createClient({ url: 'redis://:${REDIS_PASSWORD}@redis:6379/${QUEUE_REDIS_DB}' }).connect().then(()=>process.exit(0)).catch(()=>process.exit(1))"
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - connectwon-network

  # PostgreSQL
  postgres:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.db
    image: postgres:17
    container_name: postgres
    restart: unless-stopped
    env_file:
      - ../../.env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TZ=${TZ}
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - '0.0.0.0:5432:5432'
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ../database/conf/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ../database/conf/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ../database/init:/docker-entrypoint-initdb.d:ro
    command: >
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $${POSTGRES_USER} -d postgres -h 127.0.0.1 -p 5432']
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - connectwon-network

  # Redis (Ï∫êÏãú/ÏÑ∏ÏÖò Ïä§ÌÜ†Ïñ¥)
  redis:
    image: redis:7-alpine
    container_name: redis
    env_file:
      - ../../.env
    ports:
      - '0.0.0.0:6379:6379'
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      - REDIS_MAXMEMORY=${REDIS_MAXMEMORY:-512mb}
      - REDIS_EVICTION=${REDIS_EVICTION:-allkeys-lru}
    command: >
      sh -c 'exec redis-server
        --appendonly yes
        --appendfsync everysec
        --requirepass "$${REDIS_PASSWORD}"
        --maxmemory "$${REDIS_MAXMEMORY}"
        --maxmemory-policy "$${REDIS_EVICTION}"'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD-SHELL', 'redis-cli -a $${REDIS_PASSWORD} ping | grep PONG']
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - connectwon-network

  # RedisInsight (Î™®ÎãàÌÑ∞ÎßÅ UI)
  redisinsight:
    image: redis/redisinsight:latest
    container_name: redisinsight
    ports:
      - '0.0.0.0:${REDISINSIGHT_PORT:-5540}:5540'
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - redisinsight:/data
    networks:
      - connectwon-network

  # n8n (ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏûêÎèôÌôî)
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    env_file:
      - ../../.env
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:${N8N_PORT:-5678}/
      - GENERIC_TIMEZONE=${TZ:-Asia/Seoul}
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:?N8N_BASIC_AUTH_PASSWORD is required}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY is required}
      - EXECUTIONS_PROCESS=own
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_TIMEOUT=${N8N_EXECUTIONS_TIMEOUT:-3600}
      - EXECUTIONS_MAX_TIMEOUT=${N8N_EXECUTIONS_MAX_TIMEOUT:-14400}
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      - N8N_BINARY_DATA_STORAGE_PATH=/home/node/.n8n/binaryData
    ports:
      - '0.0.0.0:${N8N_PORT:-5678}:5678'
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:5678/']
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - connectwon-network

  # Prometheus (Î™®ÎãàÌÑ∞ÎßÅ Î∞è ÏïåÎ¶º)
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../monitoring/alerts.yml:/etc/prometheus/alerts.yml:ro
    ports:
      - '0.0.0.0:9090:9090'
    restart: unless-stopped
    networks:
      - connectwon-network

  # Grafana (Î™®ÎãàÌÑ∞ÎßÅ ÎåÄÏãúÎ≥¥Îìú)
  grafana:
    image: grafana/grafana:10.4.5
    container_name: grafana
    ports:
      - '0.0.0.0:${GF_SERVER_HTTP_PORT:-3030}:3000'
    env_file:
      - ../../.env
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:?set_in_.env}
      - GF_SECURITY_SECRET_KEY=${GF_SECURITY_SECRET_KEY}
      - GF_SERVER_HTTP_PORT=3000
      - GF_SERVER_ROOT_URL=http://localhost:${GF_SERVER_HTTP_PORT:-3030}
    volumes:
      - ../monitoring/grafana.ini:/etc/grafana/grafana.ini:ro
      - ../monitoring/dashboards.json:/var/lib/grafana/dashboards/dashboards.json:ro
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - connectwon-network

  # Playwright (E2E ÌÖåÏä§Ìä∏)
  e2e:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.e2e
    container_name: e2e
    env_file:
      - ../../.env
    networks:
      - connectwon-network
    environment:
      - BASE_URL=http://web:3000
      - ADMIN_BASE_URL=http://admin:3001
      - API_URL=http://api:8000
      - NX_DAEMON=false
      - NX_CLOUD=${NX_CLOUD:-false}
      - NX_CLOUD_ACCESS_TOKEN=${NX_CLOUD_ACCESS_TOKEN}
    depends_on:
      web:
        condition: service_healthy
      api:
        condition: service_healthy
      admin:
        condition: service_healthy
    shm_size: '1gb'
    volumes:
      - ../../apps/e2e/test-results:/app/apps/e2e/test-results

  # Nginx Î¶¨Î≤ÑÏä§ ÌîÑÎ°ùÏãú
  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    ports:
      - '0.0.0.0:${NGINX_PORT:-80}:80'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      web:
        condition: service_healthy
      api:
        condition: service_healthy
      admin:
        condition: service_healthy
    networks:
      - connectwon-network

volumes:
  pg_data:
    driver: local
  redis_data:
    driver: local
  redisinsight:
  n8n_data:

networks:
  connectwon-network:
    driver: bridge
